<html>
<head>
    <script src="motorSim.js"> </script>
    <script src="chart.js"> </script>
    <script src="pid.js"> </script>
    <style>
    body {
        font-family: monospace;
    }
    .group {
        border: 1px solid #eeeeee;
        border-radius: 2px;
    }
    .pidConstInput {
        width: 45px;
        margin-left: 4px;
    }
    .inl {
        display: inline;
    }
    .pidParamsTable td {
        align-content: right;
    }
    .liveParamsTable {
        border-spacing: 0px;
    }
    .liveParamsTable td {
        border: 1px solid #eeeeee;
    }
    </style>
</head>
<body>
    <canvas id="chart" width="1024" height="200"> </canvas>
    <table style="border-spacing: 0px;">
     <tr>
      <td class=group>
        <table class=liveParamsTable>
        <tr>
            <td>Speed</td><td id=spdDisplay></td>
            <td>Accel</td><td id=accelDisplay></td>
        </tr>
        <tr>
            <td>Power</td><td  style="width:6ch;" id=powerDisplay></td>
            <td>Heat</td><td id=motorHeatDisplay></td>
        </tr>
        <tr>
            <td>Imotor</td><td id=ImotorDisplay></td>
            <td>IBatt</td><td id=IbattDisplay></td>
        </tr>
        <tr>
            <td>Wh/km</td><td id=whKmDisplay></td>
            <td>Avg</td><td id=whKmAvgDisplay></td>
        </tr>
        <tr>
            <td>Wh</td><td id=whDisplay></td>
            <td>km</td><td id=kmDisplay></td>
        </tr>
        <tr>
            <td>Throttle</td>
            <td colspan=2><input type="range" min="0" max="1000" value="0" id="throttle"></input></td>
            <td id=throttleDisplay width=70>0.0</td>
        </tr>
        <tr>
            <td>EffThrot</td>
            <td colspan=2><input type="range" min="0" max="1000" value="0" id="effThrottle" disabled></input></td>
            <td id=effThrottleDisplay width=60>0.0</td>
        </tr>
        <tr>
            <td>Slope %</td>
            <td colspan=2><input type="range" min="0" max="300" value="0" id="slopeSlider"></input></td>
            <td id=slopeDisplay width=60>0.0</td>
        </tr>
      </table></td>
      <td class=group id=ccPidContainer></td>
      <td class=group id=slPidContainer></td>
      <td class=group><button onclick='onResetButton()'>reset</button></td>
     </tr>
    </table>
</body>
<script>
    function byId(id) { return document.getElementById(id); }
    function numVal(id) {
        let val = byId(id).value;
        let n = parseFloat(val);
        if (isNaN(n)) {
            throw new Error("Not a number");
        }
        return n;
    }
    let ccPid = new PidControllerGui("cc", 0.45, 0.4, 0, 20);
    ccPid.createGui(document.getElementById("ccPidContainer"), "Cruise control PID", "Maintain speed", 60);
    let slPid = new PidLimiter("sl", 0.45, 0.4, 0, 30);
    slPid.createGui(document.getElementById("slPidContainer"), "Sleep limit PID", "Max speed", 60);

    let throttleSlider = byId("throttle");
    let effThrottleSlider = byId("effThrottle");
    let slopeSlider = byId("slopeSlider");
    let canvas = byId('chart');
    canvas.width = window.innerWidth - 10;
    let chart = new LiveChart(canvas, 60);
    chart.addSeries('speed', '#ff0000', 60);
    chart.addSeries('effThrottle', '#00eeff', 100);
    chart.addSeries('ccTarget', '#dddddd', 60);

    let powerDisplay = byId("powerDisplay");
    let ImotorDisplay = byId("ImotorDisplay");
    let IbattDisplay = byId("IbattDisplay");
    let whKmDisplay = byId("whKmDisplay");
    let whDisplay = byId("whDisplay");
    let kmDisplay = byId("kmDisplay");
    let spdDisplay = byId("spdDisplay");
    let accelDisplay = byId("accelDisplay");
    let throttleDisplay = byId("throttleDisplay");
    let effThrottleDisplay = byId("effThrottleDisplay");
    let whKmAvgDisplay = byId("whKmAvgDisplay");
    let motorHeatDisplay = byId("motorHeatDisplay");

    let ebike = new Ebike({
        motorWindingR: 0.1,
        motorKv: 7.4,
        motorI0: 0.9,
        battVoltage: 60,
        battR: 0.15,
        battMaxI: 28,
        systemR: 0.1,
        wheelRadius: 0.3685,
        wheelRR: 0.010,
        cdA: 0.62,
        weight: 110,
        slope: 0.0
    });
    let gActivePid = null;
    let gPidTimer = null;

    throttleSlider.oninput = function() {
        let throttle = throttleSlider.value / 1000;
        ebike.setThrottle(throttle);
        throttleDisplay.innerText = tenth(throttle * 100);
    }

    ccTargetSlider.oninput = function() {
        let chk = byId("ccEnableChk");
        let ccTargetSpeed = ccTargetSlider.value / 10;
        byId("ccDisplay").innerText = ccTargetSpeed;
        if (!gActivePid || gActivePid.id !== "cc") {
            enableCruiseControl(ccTargetSpeed);
        }
        gActivePid.setTarget(ccTargetSpeed);
    }
    slSlider.oninput = function() {
        let chk = byId("slEnableChk");
        slSpeed = slSlider.value / 10;
        byId("slDisplay").innerText = slSpeed;
        if (!gActivePid || gActivePid.id !== "sl") {
            enableSpeedLimit(slSpeed);
        }
        gActivePid.setTarget(slSpeed);
    }

    slopeSlider.oninput = function() {
        ebike.slope = slopeSlider.value / 1000;
        byId("slopeDisplay").innerText = tenth(ebike.slope * 100);
    }
    let km = 0;
    let wh = 0;
    let kph = 0;
    const timeStep = 0.030;
    ebike.setThrottle(0.0);
    setInterval(() => {
        let kphOld = kph;
        kph = ebike.tick(timeStep) * 3.6;
        let P = ebike.curBattI * ebike.battVoltage;
        wh += P * timeStep / 3600;
        km += ((kphOld + kph) / 2) * timeStep / 3600;
        let sample = [kph, (gActivePid ? ebike.targetThrottle : ebike.effThrottle) * 100];
        if (gActivePid) {
            sample.push(gActivePid.setpoint) * 3.6;
        }
        chart.addSample(sample);
        powerDisplay.innerText = tenth(P);
        ImotorDisplay.innerText = tenth(ebike.curMotorI);
        IbattDisplay.innerText = tenth(ebike.curBattI);
        whKmDisplay.innerText = tenth(P / kph);
        whDisplay.innerText = tenth(wh);
        kmDisplay.innerText = tenth(km);
        whKmAvgDisplay.innerText = tenth(wh/km);
        motorHeatDisplay.innerText = tenth(ebike.motorHeatW());
        spdDisplay.innerText = Math.round(kph * 100)/100;
        accelDisplay.innerText = tenth((kph - kphOld) / timeStep);
        effThrottle.value = ebike.effThrottle * 1000;
        effThrottleDisplay.innerText = Math.round(ebike.effThrottle * 10000) / 100;
    }, timeStep * 1000);

function enableCruiseControl(ccTargetSpeed) {
    byId("slEnableChk").checked = false;
    byId("ccEnableChk").checked = true;
    ccPid = new PidController(numVal("ccPidP"), numVal("ccPidI"), numVal("ccPidD"), ccTargetSpeed);
    ccPid.id = "cc";
    ccPid.configI = function() {
        this.setIntegralLimits(numVal("ccPidILimP"), numVal("ccPidIStartP"), numVal("ccPidILimN"));
    }.bind(ccPid);
    ccPid.configI();
    ccPid.overshoot = 0;
    ccPid.slider = byId("ccTargetSlider");
    ccPid.errDisplay = byId("ccErrDisplay");
    ccPid.pDisplay = byId("ccPDisplay");
    ccPid.iDisplay = byId("ccIDisplay");
    ccPid.dDisplay = byId("ccDDisplay");
    ccPid.outDisplay = byId("ccOutDisplay");
    ccPid.overshootDisplay = byId("ccOvershootDisplay");
    ccPid.process = function() {
        let curKph = ebike.curSpeed() * 3.6;
        let output = this.loop(curKph, 0.1);
        if (output > 1) {
            output = 1;
        } else if (output < 0) {
            output = 0;
        }
        if (this.error > 0) {
            this.overshoot = 0;
        } else {
            if (-this.error > this.overshoot) {
                this.overshoot = -this.error;
            }
        }
        this.overshootDisplay.innerText = this.overshoot;
        return output;
    }.bind(ccPid);
    gActivePid = ccPid;
    startPidTimer(ccPid);
}
function enableSpeedLimit(speedLimit) {
    byId("ccEnableChk").checked = false;
    byId("slEnableChk").checked = true;
    let slPid = new PidLimiter(numVal("slPidP"), numVal("slPidI"), numVal("slPidD"), speedLimit);
    slPid.configI = function() {
        this.setIntegralLimits(numVal("slPidILim"), numVal("slPidIStart"));
    }.bind(slPid);
    slPid.configI();
    slPid.id = "sl";
    slPid.isLimiter = true;
    slPid.slider = byId("slTarget");
    slPid.errDisplay = byId("slErrDisplay");
    slPid.pDisplay = byId("slPDisplay");
    slPid.iDisplay = byId("slIDisplay");
    slPid.dDisplay = byId("slDDisplay");
    slPid.outDisplay = byId("slOutDisplay");
    slPid.process = function() {
        let curKph = ebike.curSpeed() * 3.6;
        let output = this.loop(curKph, 0.1);
        if (output == null) {
            return null;
        }
        output = ebike.effThrottle + output;
        if (output > 1.0) {
            output = 1.0;
        } else if (output < 0.0) {
            output = 0.0;
        }
        return output;
    }.bind(slPid);
    gActivePid = slPid;
    startPidTimer(slPid);
}

function startPidTimer(pid) {
    if (gPidTimer) {
        clearInterval(gPidTimer);
        gPidTimer = null;
    }
    gPidTimer = setInterval(() => {
        output = pid.process();
        if (output != null) {
            output = Math.round(output*3000);
            pid.outDisplay.innerText = output + 1000;
            output /= 3000;
            ebike.setThrottle(output);
            throttleSlider.value = output * 1000;
            throttleDisplay.innerText = Math.round(output * 10000)/100;
        } else {
            pid.outDisplay.innerText = "N/A";
        }
        pid.errDisplay.innerText = pid.error;
        pid.pDisplay.innerText = pid.proportional;
        pid.iDisplay.innerText = pid.integral;
        pid.dDisplay.innerText = pid.derivative;
    }, 100);
}

function onCcPidConstChange() {
    if (!ccPid) {
        return;
    }
    ccPid.setGains(numVal("ccPidP"), numVal("ccPidI"), numVal("ccPidD"));
    ccPidConfigI();
}
function onSlPidConstChange() {
    if (!gActivePid || gActivePid.id != "sl") {
        return;
    }
    gActivePid.setGains(numVal("slPidP"), numVal("slPidI"), numVal("slPidD"));
    gActivePid.configI();
}

function onResetButton() {
    ebike.reset();
    if (gActivePid) {
        gActivePid.reset();
    }
    chart.reset();
}
</script>
</html>

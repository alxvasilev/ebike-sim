<html>
<head>
    <script src="motorSim.js"> </script>
    <script src="chart.js"> </script>
    <script src="pidGui.js"> </script>
    <style>
    body {
        font-family: monospace;
    }
    .group {
        border: 1px solid #eeeeee;
        border-radius: 2px;
    }
    .pidConstInput {
        width: 45px;
        margin-left: 4px;
    }
    .inl {
        display: inline;
    }
    .pidParamsTable td {
        align-content: right;
    }
    .liveParamsTable {
        border-spacing: 0px;
    }
    .liveParamsTable td {
        border: 1px solid #eeeeee;
    }
    </style>
</head>
<body>
    <canvas id="chart" width="1024" height="200"> </canvas>
    <table style="border-spacing: 0px;">
     <tr>
      <td class=group>
        <table class=liveParamsTable>
        <tr>
            <td>Speed</td><td id=spdDisplay></td>
            <td>Accel</td><td id=accelDisplay></td>
        </tr>
        <tr>
            <td>Power</td><td  style="width:6ch;" id=powerDisplay></td>
            <td>Heat</td><td id=motorHeatDisplay></td>
        </tr>
        <tr>
            <td>Imotor</td><td id=ImotorDisplay></td>
            <td>IBatt</td><td id=IbattDisplay></td>
        </tr>
        <tr>
            <td>Wh/km</td><td id=whKmDisplay></td>
            <td>Avg</td><td id=whKmAvgDisplay></td>
        </tr>
        <tr>
            <td>Wh</td><td id=whDisplay></td>
            <td>km</td><td id=kmDisplay></td>
        </tr>
        <tr>
            <td>Effic %</td><td id=efficiencyDisplay></td>
            <td>ThrotBin</td><td id=throttleCodeDisplay></td>
        </tr>
        <tr>
            <td>Throttle</td>
            <td colspan=2><input type="range" min="0" max="1000" value="0" id="throttle"></input></td>
            <td id=throttleDisplay width=70>0.0</td>
        </tr>
        <tr>
            <td>PidThrot</td>
            <td colspan=2><input type="range" min="0" max="1000" value="0" id="pidThrottle" disabled></input></td>
            <td id=pidThrottleDisplay width=70>0.0</td>
        </tr>
        <tr>
            <td>EffThrot</td>
            <td colspan=2><input type="range" min="0" max="1000" value="0" id="effThrottle" disabled></input></td>
            <td id=effThrottleDisplay width=60>0.0</td>
        </tr>
        <tr>
            <td>Slope %</td>
            <td colspan=2><input type="range" min="0" max="300" value="0" id="slopeSlider"></input></td>
            <td id=slopeDisplay width=60>0.0</td>
        </tr>
      </table></td>
      <td class=group id=ccPidContainer></td>
      <td class=group id=slPidContainer></td>
      <td class=group><button onclick='onResetButton()'>reset</button></td>
     </tr>
    </table>
</body>
<script>
    function byId(id) { return document.getElementById(id); }
    function numVal(id) {
        let val = byId(id).value;
        let n = parseFloat(val);
        if (isNaN(n)) {
            throw new Error("Not a number");
        }
        return n;
    }
    function tenth(val) {
        let str = '' + Math.round(val * 10) / 10;
        let dec = Math.abs(val % 1);
        if (dec < 0.05 || dec >= 0.95) {
            str += '.0';
        }
        return (str.length < 4) ? (' ' + str) : str;
    }
    function anyPidEnabled() {
        return gCcPid.isEnabled() || gPidLimiters.size != 0;
    }
    function onPidEnabled(enabled) {
        if (enabled) {
            if (this.pid.isLimiter) {
                gPidLimiters.add(this);
            }
            gActivePids.unshift(this);
        } else {
            if (this.pid.isLimiter) {
                gPidLimiters.delete(this);
            }
            gActivePids.shift();
        }
    }
    let ebike = new Ebike({
        motorWindingR: 0.1,
        motorKv: 7.4,
        motorI0: 0.9,
        battVoltage: 60,
        battR: 0.15,
        battMaxI: 28,
        systemR: 0.1,
        wheelRadius: 0.3685,
        wheelRR: 0.010,
        cdA: 0.62,
        weight: 110,
        slope: 0.0
    });

    const kPidLoopInterval = 0.1;
    const kSimLoopInterval = 0.030;
    var gThrottle = 0;
    var gPidLimiters = new Set;
    var gPidTimer = null;
    var gActivePids = [];
    var gCcPid = new PidControllerGui("cc", 0.45, 0.4, 0, 20);
    gCcPid.createGui(document.getElementById("ccPidContainer"), "Cruise control PID", "Maintain speed", 60);
    gCcPid.onEnabled = onPidEnabled.bind(gCcPid);

    let gSlPid = new PidLimiterGui("sl", 0.45, 0.4, 0, 15);
    gSlPid.createGui(document.getElementById("slPidContainer"), "Sleep limit PID", "Max speed", 60);
    gSlPid.onEnabled = onPidEnabled.bind(gSlPid);
    gSlPid.ebike = ebike;
    gSlPid.process = function(inThrottle, dt) {
        let pid = this.pid;
        let output = pid.loop(inThrottle, ebike.curSpeed() * 3.6, dt);
        return this.handleOutput(output);
    }

    let throttleSlider = byId("throttle");
    let pidThrottleSlider = byId("pidThrottle");
    let effThrottleSlider = byId("effThrottle");
    let slopeSlider = byId("slopeSlider");
    let canvas = byId('chart');
    canvas.width = window.innerWidth - 10;
    let chart = new LiveChart(canvas, 60);
    chart.addSeries('speed', '#ff0000', 60);
    chart.addSeries('effThrottle', '#00eeff', 100);
    chart.addSeries('ccTarget', '#dddddd', 60);

    let powerDisplay = byId("powerDisplay");
    let ImotorDisplay = byId("ImotorDisplay");
    let IbattDisplay = byId("IbattDisplay");
    let whKmDisplay = byId("whKmDisplay");
    let whDisplay = byId("whDisplay");
    let kmDisplay = byId("kmDisplay");
    let spdDisplay = byId("spdDisplay");
    let accelDisplay = byId("accelDisplay");
    let throttleCodeDisplay = byId("throttleCodeDisplay");
    let throttleDisplay = byId("throttleDisplay");
    let pidThrottleDisplay = byId("pidThrottleDisplay");
    let effThrottleDisplay = byId("effThrottleDisplay");
    let whKmAvgDisplay = byId("whKmAvgDisplay");
    let motorHeatDisplay = byId("motorHeatDisplay");
    let efficiencyDisplay = byId("efficiencyDisplay");

    throttleSlider.oninput = function() {
        gThrottle = throttleSlider.value / 1000;
        throttleDisplay.innerText = tenth(gThrottle * 100);
        processPids();
    }
    slopeSlider.oninput = function() {
        ebike.slope = slopeSlider.value / 1000;
        byId("slopeDisplay").innerText = tenth(ebike.slope * 100);
    }
    let km = 0;
    let wh = 0;
    let kph = 0;
    ebike.setThrottle(0.0);
    function processSim() {
        let kphOld = kph;
        kph = ebike.tick(kSimLoopInterval) * 3.6;
        let P = ebike.curBattI * ebike.battVoltage;
        wh += P * kSimLoopInterval / 3600;
        km += ((kphOld + kph) / 2) * kSimLoopInterval / 3600;
        let activePid = gActivePids[0];
        let sample = [kph, (activePid ? ebike.targetThrottle : ebike.effThrottle) * 100];
        if (activePid) {
            sample.push(activePid.pid.setpoint) * 3.6;
        }
        chart.addSample(sample);
        powerDisplay.innerText = tenth(P);
        ImotorDisplay.innerText = tenth(ebike.curMotorI);
        IbattDisplay.innerText = tenth(ebike.curBattI);
        whKmDisplay.innerText = tenth(P / kph);
        whDisplay.innerText = tenth(wh);
        kmDisplay.innerText = tenth(km);
        whKmAvgDisplay.innerText = tenth(wh/km);
        motorHeatDisplay.innerText = tenth(ebike.motorHeatW());
        spdDisplay.innerText = Math.round(kph * 100)/100;
        accelDisplay.innerText = tenth((kph - kphOld) / kSimLoopInterval);
        efficiencyDisplay.innerHTML = tenth(ebike.curEfficiency()*100);
        effThrottle.value = ebike.effThrottle * 1000;
        effThrottleDisplay.innerText = (ebike.effThrottle * 100).toFixed(2);
    }

    setInterval(processSim, kSimLoopInterval * 1000);
    setInterval(processPids, kPidLoopInterval * 1000);

function processPids() {
        let throttle = gCcPid.isEnabled()
            ? gCcPid.process(ebike.curSpeed() * 3.6, kPidLoopInterval)
            : gThrottle;
        for (let limiter of gPidLimiters) {
            throttle = limiter.process(throttle, kPidLoopInterval);
        }
        throttle = Math.round(throttle * 3000);
        throttleCodeDisplay.innerText = throttle + 1000;
        throttle /= 3000;
        ebike.setThrottle(throttle);
        pidThrottleSlider.value = throttle * 1000;
        pidThrottleDisplay.innerText = (throttle * 100).toFixed(2);
    }

function onResetButton() {
    ebike.reset();
    for (let pid of gActivePids) {
        pid.pid.reset();
    }
    chart.reset();
}
</script>
</html>
